/*!
 * escher.js v0.0.5 
 * Copyright 2012, Spider Strategies <nathan.bowser@spiderstrategies.com> 
 * escher.js may be freely distributed under the BSD license. 
*/
(function(e,t){typeof define=="function"&&define.amd?define(["backbone"],t):t(e.Backbone)})(this,function(e){"use strict";var t=function(e){if(!e.base)throw new Error("Escher must receive the base view");_.defaults(e,{leftOffset:20,bottomOffset:20,labelField:"name"}),this.opts=e,this.steps=[new n({view:e.base,label:this.name,opts:this.opts})],this.on("changed",this._resize)};t.prototype.on=e.Events.on,t.prototype.off=e.Events.off,t.prototype.trigger=e.Events.trigger,t.prototype._resize=function(){if(this.length()===1)return;var e=this.top(),t=e.$el.outerHeight(),n=this.opts.bottomOffset;_.each(_.first(this.steps,_.indexOf(this.steps,e)).reverse(),function(e){e.view.$el.height(t),t+=e.retreat.$el.outerHeight(!0)-n,e.$el.height(t)}),this.bottom().$el.height(t)},t.prototype.top=function(){return _.last(this.steps)},t.prototype.bottom=function(){return _.first(this.steps)},t.prototype.push=function(e,t){this.trigger("changing");var r=_.last(this.steps).drop(),i=r.view[this.opts.labelField],s=r.view.$el,o=(new n({view:e,label:i,opts:this.opts,parent:s})).render();o.on("close",this._retreat,this),this.steps.push(o),this.trigger("changed")},t.prototype._retreat=function(e){var t=this;_.each(_.rest(t.steps,_.indexOf(t.steps,e)),function(e){t.pop()})},t.prototype.pop=function(){this.length()>1&&(this.trigger("changing"),this.steps.pop().destroy(),_.last(this.steps).rise(),this.trigger("changed"))},t.prototype.length=function(){return this.steps.length};var n=e.View.extend({className:"escher-step",attributes:{style:"position: absolute; left: 0; top: 0; width: 100%"},initialize:function(e){this.view=e.view,this.opts=e.opts,this.parent=e.parent,this.retreat=(new r({label:e.label})).render();var t=this;this.retreat.on("close",function(){t.trigger("close",t)})},render:function(){return this.view.$el.addClass("escher-step-view"),this.view.trigger("view:activate"),this.view.$el.css({"margin-left":this.opts.leftOffset,"margin-bottom":-1*this.opts.bottomOffset,width:"100%"}),this.$el.append(this.retreat.el),this.$el.append(this.view.render().el),this.parent.append(this.$el),this},drop:function(){return this.view.undelegateEvents(),this.view.trigger("view:deactivate"),this.view.$el.addClass("escher-step-view-covered"),this},rise:function(){this.view.$el.css("height",""),this.$el.css("height",""),this.view.delegateEvents(),this.view.trigger("view:activate"),this.view.$el.removeClass("escher-step-view-covered")},destroy:function(){this.view.trigger("view:deactivate"),this.retreat.off("close"),this.retreat.remove(),this.remove(),this.view=null,this.retreat=null}}),r=e.View.extend({className:"escher-step-retreat",events:{"click a":"close"},initialize:function(e){this.label=e.label},close:function(e){this.trigger("close")},render:function(){return this.$el.html('<header><a href="#">'+this.label+"</a></header>"),this}});return e.Escher=t,e});