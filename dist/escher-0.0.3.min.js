/*!
 * escher.js v0.0.3 
 * Copyright 2012, Spider Strategies <nathan.bowser@spiderstrategies.com> 
 * escher.js may be freely distributed under the BSD license. 
*/
(function(e,t){typeof define=="function"&&define.amd?define(["backbone"],t):t(e.Backbone)})(this,function(e){"use strict";var t=function(e){if(!e.base)throw new Error("Escher must receive the base view");_.defaults(e,{topOffset:60,leftOffset:20,bottomOffset:20,labelField:"name"}),this.opts=e,this.base=e.base,this.steps=[],this.on("changed",this._resize);var t=this,n=function(){t._resize()};this.on("changed",function(){t.length()?$(window).resize(n):$(window).unbind("resize",n)})};t.prototype.on=e.Events.on,t.prototype.off=e.Events.off,t.prototype.trigger=e.Events.trigger,t.prototype._resize=function(){if(this.length()===0){this.base.$el.css("height","");return}var e=this.top();e.view.$el.css("height",""),e.$el.css("height","");var t=e.$el.outerHeight(),n=this.opts.bottomOffset*2;_.each(_.first(this.steps,_.indexOf(this.steps,e)).reverse(),function(e,r){t+=n,e.view.$el.height(0),e.$el.height(t)}),this.length()===1&&(this.top().$el.css("height","auto"),t-=this.opts.bottomOffset),this.base.$el.height(t)},t.prototype.top=function(){return _.last(this.steps)},t.prototype.bottom=function(){return _.first(this.steps)},t.prototype.push=function(e,t){this.trigger("changing");var r=_.last(this.steps),i=r&&r.view[this.opts.labelField]||this.base[this.opts.labelField],s=r&&r.$el||this.base.$el.parent(),o;r?o={left:this.opts.leftOffset,top:this.opts.topOffset,width:r.$el.width()}:(this.base.$el.css("overflow","hidden"),o={left:this.base.$el.offset().left,top:this.base.$el.offset().top,width:this.base.$el.outerWidth()}),r?r.drop():(this.base.undelegateEvents(),this.base.trigger("view:deactivate"));var u=(new n({view:e,label:i,opts:this.opts,container:s,position:o})).render();u.on("close",this._retreat,this),this.steps.push(u),this.trigger("changed")},t.prototype._retreat=function(e){var t=this;_.each(_.rest(t.steps,_.indexOf(t.steps,e)),function(e){t.pop()})},t.prototype.pop=function(){this.trigger("changing"),this.steps.pop().destroy();var e=_.last(this.steps);e?e.rise():(this.base.delegateEvents(),this.base.trigger("view:activate"),this.base.$el.css("overflow","")),this.trigger("changed")},t.prototype.length=function(){return this.steps.length};var n=e.View.extend({className:"escher-step",attributes:{style:"position: absolute"},initialize:function(e){this.view=e.view,this.opts=e.opts,this.retreat=(new r({label:e.label})).render(),this.position=e.position,this.container=e.container;var t=this;this.retreat.on("close",function(){t.trigger("close",t)})},render:function(){return this.view.$el.addClass("escher-step-view"),this.view.trigger("view:activate"),this.$el.css(this.position),this.view.$el.css({"margin-left":this.opts.leftOffset,"margin-bottom":-1*this.opts.bottomOffset,width:"100%"}),this.$el.append(this.retreat.el),this.$el.append(this.view.render().el),this.container.append(this.$el),this},drop:function(){return this.view.undelegateEvents(),this.view.trigger("view:deactivate"),this},destroy:function(){this.view.undelegateEvents(),this.view.$el.removeClass("escher-step-view"),this.view.$el.parent().remove(),this.view.remove(),this.view.trigger("view:deactivate"),this.retreat.off("close"),this.retreat.remove(),this.retreat=null},rise:function(){this.view.delegateEvents(),this.view.trigger("view:activate")}}),r=e.View.extend({className:"escher-step-retreat",events:{"click a":"close"},initialize:function(e){this.label=e.label},close:function(e){this.trigger("close")},render:function(){return this.$el.html('<header><a href="#">'+this.label+"</a></header>"),this}});return e.Escher=t,e});